"""
–ü—Ä–æ—Å—Ç–æ–π –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä –∞—Ä–∏—Ñ–º–µ—Ç–∏—á–µ—Å–∫–∏—Ö –≤—ã—Ä–∞–∂–µ–Ω–∏–π.
–î–æ–ø—É—â–µ–Ω–∏–µ: –º–µ–∂–¥—É —á–∏—Å–ª–∞–º–∏ –∏ –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞–º–∏ –≤—Å–µ–≥–¥–∞ —Å—Ç–æ—è—Ç –ø—Ä–æ–±–µ–ª—ã.
–ü—Ä–∏–º–µ—Ä: "2 + 5 * ( 3 - 7 )"
"""
def operation(a, b, token):
    if token == '+':
        return a + b
    if token == '-':
        return a - b
    if token == '*':
        return a * b
    if token == '/':
        return a / b
    if token == '%':
        return a % b
    if token == '^':
        return a ** b
    raise ValueError(f"–≠—Ç–æ –∑–∞—á–µ–º?: {token}")

def calculate(input_string: str) -> float:
    """
    –ì–ª–∞–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è: –ø—Ä–∏–Ω–∏–º–∞–µ—Ç —Å—Ç—Ä–æ–∫—É-–≤—ã—Ä–∞–∂–µ–Ω–∏–µ –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≤—ã—á–∏—Å–ª–µ–Ω–∏–π.
    """
    tokens = tokenize(input_string)
    postfix = to_postfix(tokens)
    result = eval_postfix(postfix)
    return result


def tokenize(expression: str) -> list[str]:
    
    """
    –†–∞–∑–±–∏–≤–∞–µ—Ç —Å—Ç—Ä–æ–∫—É –Ω–∞ —Ç–æ–∫–µ–Ω—ã (—á–∏—Å–ª–∞, —Å–∫–æ–±–∫–∏, –æ–ø–µ—Ä–∞—Ç–æ—Ä—ã).
    –ü—Ä–∏–º–µ—Ä: "2 + 5 * ( 3 - 7 )" -> ["2", "+", "5", "*", "(", "3", "-", "7", ")"]
    """
    tokens = expression.split()
    return tokens


def to_postfix(tokens: list[str]) -> list[str]:
    """
    –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ—Ç –≤—ã—Ä–∞–∂–µ–Ω–∏–µ –≤ –ø–æ—Å—Ç—Ñ–∏–∫—Å–Ω—É—é —Ñ–æ—Ä–º—É (–æ–±—Ä–∞—Ç–Ω–∞—è –ø–æ–ª—å—Å–∫–∞—è –∑–∞–ø–∏—Å—å).

    –ó–¥–µ—Å—å –º—ã –∏—Å–ø–æ–ª—å–∑—É–µ–º –î–í–ê "—Å—Ç–µ–∫–∞":
      1. output = []   # –≤—ã—Ö–æ–¥–Ω–æ–π —Å–ø–∏—Å–æ–∫ (—Å—é–¥–∞ —Å–∫–ª–∞–¥—ã–≤–∞–µ–º –≥–æ—Ç–æ–≤—ã–µ —Ç–æ–∫–µ–Ω—ã –≤ –ø–æ—Å—Ç—Ñ–∏–∫—Å–µ)
      2. stack = []    # —Å—Ç–µ–∫ –æ–ø–µ—Ä–∞—Ç–æ—Ä–æ–≤ –∏ —Å–∫–æ–±–æ–∫

    üîπ –ü—Ä–∏–º–µ—Ä—ã:
    ["2", "+", "3"]                -> ["2", "3", "+"]
    ["2", "+", "3", "*", "4"]      -> ["2", "3", "4", "*", "+"]
    ["(", "2", "+", "3", ")", "*", "4"] -> ["2", "3", "+", "4", "*"]
    ["2", "+", "5", "*", "(", "3", "-", "7", ")"] -> ["2", "5", "3", "7", "-", "*", "+"]
    """
    output: list[str] = []  # —Å—é–¥–∞ –ø–æ–π–¥—É—Ç —á–∏—Å–ª–∞ –∏ –æ–ø–µ—Ä–∞—Ç–æ—Ä—ã –≤ –ø–æ—Ä—è–¥–∫–µ –ø–æ—Å—Ç—Ñ–∏–∫—Å–∞
    stack: list[str] = []   # –≤—Ä–µ–º–µ–Ω–Ω—ã–π —Å—Ç–µ–∫ –¥–ª—è –æ–ø–µ—Ä–∞—Ç–æ—Ä–æ–≤ –∏ —Å–∫–æ–±–æ–∫
    operations = ["+", "-", "*", "/", "^", "%", "(", ")"]
    priority = {'+': 0,
                '-': 0,
                '(' : -2, 
                ')': -1,
                '*' : 2,
                '/' : 2,
                '%' : 1, 
                '^' : 2 }
    for token in tokens:
        if token not in operations and not token.isdigit():
            raise ValueError(f"–Ω–µ–≤–µ—Ä–Ω—ã–π —Å–∏–º–≤–æ–ª: {token}")
        if token in operations:
            if token != ")":
              while len(stack) != 0  and priority[stack[-1]] >= priority[token] and token != "(":
                  output.append(stack.pop())
              stack.append(token)
            else:
                while len(stack) != 0 and stack[-1] != "(":
                  output.append(stack.pop())
                if len(stack) == 0:
                    raise ValueError("–ü–µ—Ä–µ—Å—á–∏—Ç–∞–π —Å–∫–æ–±–∫–∏")
                stack.pop()
        else:  
            output.append(token)
    while len(stack) != 0 :
        s = stack.pop()
        if s == ")" or s == "(":
            raise ValueError("–ü–µ—Ä–µ—Å—á–∏—Ç–∞–π —Å–∫–æ–±–∫–∏")
        output.append(s)
    return output


def eval_postfix(postfix_tokens: list[str]) -> float:
    """
    –°—á–∏—Ç–∞–µ—Ç –∑–Ω–∞—á–µ–Ω–∏–µ –≤—ã—Ä–∞–∂–µ–Ω–∏—è –≤ –ø–æ—Å—Ç—Ñ–∏–∫—Å–Ω–æ–π –∑–∞–ø–∏—Å–∏.
    –ó–¥–µ—Å—å –º—ã –∏—Å–ø–æ–ª—å–∑—É–µ–º –û–î–ò–ù —Å—Ç–µ–∫ —á–∏—Å–µ–ª.

    –ê–ª–≥–æ—Ä–∏—Ç–º:
      1. –ò–¥—ë–º —Å–ª–µ–≤–∞ –Ω–∞–ø—Ä–∞–≤–æ –ø–æ —Ç–æ–∫–µ–Ω–∞–º.
      2. –ï—Å–ª–∏ —á–∏—Å–ª–æ ‚Äî –∫–ª–∞–¥—ë–º –≤ —Å—Ç–µ–∫.
      3. –ï—Å–ª–∏ –æ–ø–µ—Ä–∞—Ç–æ—Ä ‚Äî –¥–æ—Å—Ç–∞—ë–º –¥–≤–∞ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö —á–∏—Å–ª–∞ –∏–∑ —Å—Ç–µ–∫–∞,
         –ø—Ä–∏–º–µ–Ω—è–µ–º –æ–ø–µ—Ä–∞—Ç–æ—Ä –∏ –∫–ª–∞–¥—ë–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç –æ–±—Ä–∞—Ç–Ω–æ –≤ —Å—Ç–µ–∫.
      4. –í –∫–æ–Ω—Ü–µ –≤ —Å—Ç–µ–∫–µ –¥–æ–ª–∂–Ω–æ –æ—Å—Ç–∞—Ç—å—Å—è —Ä–æ–≤–Ω–æ –æ–¥–Ω–æ —á–∏—Å–ª–æ ‚Äî —ç—Ç–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç.

    üîπ –ü—Ä–∏–º–µ—Ä—ã:

    ["2", "3", "+"]
    –°—Ç–µ–∫: [] ‚Üí [2] ‚Üí [2, 3] ‚Üí [5]
    –†–µ–∑—É–ª—å—Ç–∞—Ç = 5

    ["2", "3", "5", "*", "+"]
    –°—Ç–µ–∫: [] ‚Üí [2] ‚Üí [2, 3] ‚Üí [2, 3, 5]
          –æ–ø–µ—Ä–∞—Ç–æ—Ä *: [2, 15]
          –æ–ø–µ—Ä–∞—Ç–æ—Ä +: [17]
    –†–µ–∑—É–ª—å—Ç–∞—Ç = 17

    ["10", "2", "-", "3", "+"]
    –°—Ç–µ–∫: [] ‚Üí [10] ‚Üí [10, 2]
          –æ–ø–µ—Ä–∞—Ç–æ—Ä -: [8]
          ‚Üí [8, 3]
          –æ–ø–µ—Ä–∞—Ç–æ—Ä +: [11]
    –†–µ–∑—É–ª—å—Ç–∞—Ç = 11

    ["2", "3", "+", "4", "1", "-", "*"]
    ( (2+3) * (4-1) )
    –°—Ç–µ–∫: [] ‚Üí [2] ‚Üí [2, 3]
          –æ–ø–µ—Ä–∞—Ç–æ—Ä +: [5]
          ‚Üí [5, 4] ‚Üí [5, 4, 1]
          –æ–ø–µ—Ä–∞—Ç–æ—Ä -: [5, 3]
          –æ–ø–µ—Ä–∞—Ç–æ—Ä *: [15]
    –†–µ–∑—É–ª—å—Ç–∞—Ç = 15
    """
    stack_ans = []
    operations = ["+", "-", "*", "/", "^", "%"]
    for token in postfix_tokens:
        if token in operations:
            if len(stack_ans) < 2:
                raise ValueError("–ù–µ—Ç –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ–≥–æ –∫–æ–ª-–≤–∞ —á–∏—Å–µ–ª")
            a, b = stack_ans[-2], stack_ans[-1]
            stack_ans.pop()
            stack_ans.pop()
            stack_ans.append(operation(a, b, token))

        else:
            stack_ans.append(int(token))
    return stack_ans[-1]
            
